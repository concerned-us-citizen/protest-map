# SQLite Database Migration Plan

This document outlines the plan to migrate the application's data model from a prebuilt JSON file to a client-side SQLite database.

## Potential Issue: SQLite File Staleness on Cloudflare

The SQLite file is updated periodically by a GitHub action and served via Cloudflare. Cloudflare's caching could lead to users receiving an outdated version of the SQLite database file.

## Proposed Solution for Staleness

To mitigate this, implement a versioning strategy for the SQLite file:

1.  Include a version identifier (e.g., a timestamp or a commit hash) in the filename of the SQLite database generated by the GitHub action (e.g., `events_vYYYYMMDDHHMMSS.sqlite`).
2.  Update a small, non-cached file (like a JSON file or a simple text file) with the latest database filename/version identifier. This file should not be aggressively cached by Cloudflare (or use cache-busting techniques when fetching it).
3.  On the client-side, the application should first fetch this version file to get the name of the latest SQLite database file, and then fetch the database file using that dynamic name.

This ensures that even if Cloudflare caches the old database file, the client will always know the name of the latest version and fetch that one.

## Detailed Conversion Plan

Here is the step-by-step plan for the conversion:

1.  **Implement SQLite Loading:**
    *   Integrate a client-side SQLite library (like `sql.js`) into the project.
    *   Create a utility function or class to handle loading the `.sqlite` file (using the versioning strategy mentioned above) and initializing the SQLite database instance.

2.  **Develop Database Interaction Layer:**
    *   **Assessment:** Examine `scripts/eventDb/EventDb.ts` to determine if its code is compatible with a client-side SQLite library like `sql.js`. This likely involves checking for any Node.js-specific dependencies or APIs.
    *   **Option A (Compatible):** If compatible, move `scripts/eventDb/EventDb.ts` to a suitable location within `src/lib` (e.g., `src/lib/db/EventDatabase.ts`). Update both the client-side code (EventStore, EventFilter) and the build script (`scripts/eventDb/EventSink.ts`) to import and use the class from its new location in `src/lib`.
    *   **Option B (Not Compatible):** If not compatible, create a new file in `src/lib` (e.g., `src/lib/db/ClientEventDatabase.ts`) and implement the database interaction logic there using `sql.js`. The client-side code (EventStore, EventFilter) will use this new class, while the build scripts will continue to use the Node.js-specific implementation.

3.  **Refactor `EventStore.svelte.ts`:**
    *   Modify [`src/lib/store/EventStore.svelte.ts`](src/lib/store/EventStore.svelte.ts) to use the new database interaction layer (`EventDatabase` or `ClientEventDatabase`) instead of loading and storing data from the prebuilt JSON file.
    *   The `loadEvents` method will now be responsible for initializing the database and potentially fetching an initial set of data.
    *   Other methods in `EventStore` that previously operated on the in-memory JSON data will be updated to call the corresponding methods in the database interaction class.

4.  **Refactor `EventFilter.svelte.ts`:**
    *   Modify [`src/lib/store/EventFilter.svelte.ts`](src/lib/store/EventFilter.svelte.ts) to work with the database interaction class.
    *   Instead of filtering an in-memory array of events, the `applyFilters` method (or similar) will construct and execute SQL queries via the database interaction class.
    *   The filter state managed by `EventFilter` will be used to build the `WHERE` clauses and other parts of the SQL queries.

5.  **Update Components:**
    *   Review components that interact with `EventStore` and `EventFilter` (e.g., [`src/routes/+page.svelte`](src/routes/+page.svelte), [`src/lib/FilterPanel.svelte`](src/lib/FilterPanel.svelte), [`src/lib/Timeline.svelte`](src/lib/Timeline.svelte)).
    *   Ensure these components correctly use the updated APIs of `EventStore` and `EventFilter`, which will now return data from the database.

6.  **Testing:**
    *   Implement comprehensive tests for the new database interaction layer, `EventStore`, and `EventFilter` to ensure data is loaded and filtered correctly.
    *   Test the caching/versioning strategy to confirm the latest database file is always loaded.

## Data Flow Diagram

```mermaid
graph TD
    A[Cloudflare CDN] --> B{Fetch latest version file};
    B --> C{Get latest DB filename};
    C --> D[Fetch latest SQLite DB file];
    D --> E[Client-side App];
    E --> F[Initialize SQLite DB (sql.js)];
    E --> G[Database Interaction Class (EventDatabase/ClientEventDatabase)];
    F --> G;
    G --> H[EventStore.svelte.ts];
    G --> I[EventFilter.svelte.ts];
    H --> J[Svelte Components];
    I --> J;
    J --> G{Query Database};